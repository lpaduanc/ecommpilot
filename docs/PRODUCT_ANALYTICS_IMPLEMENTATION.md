# Product Analytics Implementation

## Overview

This document describes the analytics calculations implemented for product listings in the ecommpilot platform.

## Metrics Implemented

### 1. Categoria ABC (ABC Curve Classification)

Classification based on sales volume using the Pareto principle (80/20 rule):

- **A**: Top products that represent ~80% of cumulative sales
- **B**: Middle products that represent ~15% of cumulative sales (from 80% to 95%)
- **C**: Bottom products that represent ~5% of cumulative sales (from 95% to 100%)

**Implementation**: Products are sorted by total sales revenue and classified based on cumulative percentage.

### 2. Saúde do Estoque (Stock Health)

Indicator based on current stock vs sales velocity:

- **Alto** (High): > 30 days of stock remaining
- **Adequado** (Adequate): 14-30 days of stock remaining
- **Baixo** (Low): 7-14 days of stock remaining
- **Crítico** (Critical): < 7 days of stock remaining

**Calculation**:
```
days_of_stock = current_stock / (units_sold / period_days)
```

**Special cases**:
- No sales in period + stock > 0 = "Alto" (999 days)
- No sales in period + stock = 0 = "Crítico" (0 days)

### 3. Unidades Vendidas (Units Sold)

Total number of units sold for the product in the analysis period.

**Calculation**: Sum of all quantities from order items matching the product.

### 4. Taxa de Conversão (Conversion Rate)

Percentage of orders that contain the product out of total orders.

**Formula**:
```
conversion_rate = (orders_with_product / total_orders) * 100
```

**Example**: If 15 out of 100 orders contain Product X, conversion rate = 15%

### 5. % de Vendas (Sales Percentage)

Percentage of total store revenue generated by the product.

**Formula**:
```
sales_percentage = (product_revenue / total_store_revenue) * 100
```

### 6. Lucro Total (Total Profit)

Total profit generated by the product in the analysis period.

**Formula**:
```
total_profit = (selling_price - cost) * units_sold
```

**Note**: Requires the `cost` field to be populated in `synced_products` table. If cost is not available, it defaults to 0.

### 7. Margem (Margin)

Profit margin percentage for the product.

**Formula**:
```
margin = ((total_revenue - total_cost) / total_revenue) * 100
```

**Special cases**:
- No sales: margin = 0%
- No cost: margin = 100%

## Additional Metrics

### 8. Classificação BCG (BCG Matrix)

Products are classified using BCG Matrix analysis:

- **Estrela** (Star): High sales + High margin
- **Vaca Leiteira** (Cash Cow): Low sales + High margin
- **Interrogação** (Question Mark): High sales + Low margin
- **Abacaxi** (Dog): Low sales + Low margin

Classification is based on median sales and median margin of all products.

## Data Structure

### Analytics Object Structure

```json
{
  "name": "Product Name",
  "sessions": 0,
  "units_sold": 150,
  "conversion_rate": 25.5,
  "total_sold": 4500.00,
  "sales_percentage": 12.5,
  "total_profit": 2250.00,
  "average_price": 30.00,
  "cost": 15.00,
  "margin": 50.00,
  "stock": 200,
  "days_of_stock": 45.5,
  "abc_category": "A",
  "stock_health": "Alto",
  "classification": "Estrela",
  "orders_with_product": 42
}
```

## API Response

### GET /api/products

```json
{
  "data": [
    {
      "id": 1,
      "name": "Product Name",
      "price": 30.00,
      "cost": 15.00,
      "stock_quantity": 200,
      "analytics": {
        "units_sold": 150,
        "conversion_rate": 25.5,
        "total_sold": 4500.00,
        "sales_percentage": 12.5,
        "total_profit": 2250.00,
        "margin": 50.00,
        "abc_category": "A",
        "stock_health": "Alto",
        "days_of_stock": 45.5,
        "classification": "Estrela"
      }
    }
  ],
  "total": 1,
  "last_page": 1,
  "current_page": 1,
  "totals": {
    "total_products": 50,
    "total_sessions": 0,
    "total_units_sold": 1500,
    "total_revenue": 45000.00,
    "total_profit": 22500.00,
    "average_margin": 50.00
  },
  "abc_analysis": {
    "category_a": {
      "count": 10,
      "percentage": 20.0
    },
    "category_b": {
      "count": 15,
      "percentage": 30.0
    },
    "category_c": {
      "count": 25,
      "percentage": 50.0
    }
  }
}
```

## Implementation Details

### Service: `ProductAnalyticsService`

**File**: `app/Services/ProductAnalyticsService.php`

**Main Method**:
```php
public function calculateProductAnalytics(
    Store $store,
    Collection $products,
    int $periodDays = 30
): array
```

**Parameters**:
- `$store`: The store to analyze
- `$products`: Collection of products to analyze
- `$periodDays`: Analysis period in days (default: 30)

**Returns**: Array with keys:
- `products`: Associative array with product analytics indexed by product ID
- `totals`: Aggregated totals for all products
- `abc_analysis`: ABC category distribution

### Controller: `ProductController`

**File**: `app/Http/Controllers/Api/ProductController.php`

**Endpoint**: `GET /api/products`

**Query Parameters**:
- `search`: Search term (name, SKU)
- `status`: Filter by status (`low_stock`, `out_of_stock`)
- `per_page`: Items per page (default: 20)
- `page`: Current page (default: 1)

### Resource: `ProductResource`

**File**: `app/Http/Resources/ProductResource.php`

Analytics data is automatically included when available via the `analytics` key.

## Database Requirements

### Required Migration

Migration `2026_01_08_200030_add_cost_to_synced_products_table.php` adds the `cost` field:

```php
Schema::table('synced_products', function (Blueprint $table) {
    $table->decimal('cost', 10, 2)->nullable()->after('price');
});
```

**Status**: ✅ Already executed

## Performance Considerations

1. **Efficient Query**: All orders are fetched once per request
2. **No N+1 Queries**: All data is processed in memory after initial fetch
3. **Indexing**: Database indexes on `store_id` and `external_created_at` optimize order queries
4. **Period Limitation**: Default 30-day period keeps dataset manageable

## Product Matching Logic

Products are matched against order items using two methods:

1. **By External ID**: `order_item.product_id === synced_product.external_id` (both as strings)
2. **By Name**: Case-insensitive comparison of product names (fallback)

This dual matching ensures compatibility with different integration formats.

## Testing

### Manual Testing

1. Ensure store has synced products and orders
2. Make GET request to `/api/products`
3. Verify response includes `analytics` object with all metrics
4. Check `totals` and `abc_analysis` in response

### Test Cases to Verify

- [ ] Products with no sales show 0 metrics but valid categories
- [ ] Products without cost show 0 profit/margin
- [ ] Conversion rate calculates correctly (orders with product / total orders)
- [ ] ABC categories sum to 100% (A + B + C)
- [ ] Stock health matches expected ranges
- [ ] Sales percentage sums to ~100% for all products
- [ ] Products are correctly matched by external_id or name

## Future Enhancements

1. **Sessions Tracking**: Integrate with web analytics (Google Analytics, Hotjar)
2. **Historical Trends**: Track metrics over time for trend analysis
3. **Configurable Period**: Allow frontend to request different analysis periods
4. **Category Analytics**: Aggregate analytics by product category
5. **Variant-Level Analytics**: Track performance of individual product variants
6. **Export Functionality**: Allow downloading analytics data as CSV/Excel

## Related Files

- `app/Services/ProductAnalyticsService.php` - Analytics calculation service
- `app/Http/Controllers/Api/ProductController.php` - API controller
- `app/Http/Resources/ProductResource.php` - API resource
- `app/Models/SyncedProduct.php` - Product model
- `app/Models/SyncedOrder.php` - Order model
- `database/migrations/2026_01_08_200030_add_cost_to_synced_products_table.php` - Cost field migration
