# ==========================================================================
# PostgreSQL Configuration for EcommPilot
# ==========================================================================
# Otimizado para bulk operations (sync de ~100k pedidos)
# ==========================================================================

# -----------------------------
# Connections
# -----------------------------
listen_addresses = '*'                  # Aceita conexões de qualquer IP (necessário para Docker)
max_connections = 300                   # Aumentado para suportar múltiplos workers + app
superuser_reserved_connections = 5      # Reserva para admin

# -----------------------------
# Memory Settings
# -----------------------------
# Para container com 2GB+ de RAM
shared_buffers = 512MB                  # 25% da RAM disponível
effective_cache_size = 1536MB           # 75% da RAM disponível
work_mem = 32MB                         # Para sorts e hash tables pesados
maintenance_work_mem = 256MB            # Para VACUUM, CREATE INDEX, etc

# -----------------------------
# Write Ahead Log (WAL)
# -----------------------------
wal_buffers = 16MB                      # Buffer de WAL
min_wal_size = 1GB                      # Mínimo de WAL antes de reciclar
max_wal_size = 4GB                      # Máximo antes de checkpoint forçado

# -----------------------------
# Checkpoints
# -----------------------------
checkpoint_completion_target = 0.9      # Espalha checkpoint I/O
checkpoint_timeout = 15min              # Tempo entre checkpoints

# -----------------------------
# Query Planner
# -----------------------------
random_page_cost = 1.1                  # Assume SSD (Docker volume)
effective_io_concurrency = 200          # Threads I/O concorrentes (SSD)

# -----------------------------
# Performance Tuning para Bulk Operations
# -----------------------------
# Otimizações específicas para upserts em lote
temp_buffers = 32MB                     # Para tabelas temporárias
max_prepared_transactions = 100         # Para transações preparadas

# -----------------------------
# Timeouts
# -----------------------------
statement_timeout = 600000              # 10 minutos (em ms) - jobs podem demorar
idle_in_transaction_session_timeout = 300000  # 5 minutos
lock_timeout = 60000                    # 1 minuto para locks

# -----------------------------
# Logging (CRITICAL: Log all DDL operations to catch data loss)
# -----------------------------
log_min_duration_statement = 5000       # Log queries > 5s
log_line_prefix = '%t [%p]: [%l-1] user=%u,db=%d,app=%a,client=%h '
log_timezone = 'UTC'

# SECURITY: Log ALL DDL operations (CREATE, DROP, ALTER, TRUNCATE)
log_statement = 'ddl'                   # Log all DDL commands
log_connections = on                    # Log all connections
log_disconnections = on                 # Log all disconnections

# -----------------------------
# Autovacuum (importante para bulk operations)
# -----------------------------
autovacuum = on
autovacuum_max_workers = 4              # Mais workers para limpar rápido
autovacuum_naptime = 30s                # Roda a cada 30s
autovacuum_vacuum_scale_factor = 0.1    # Vacuum com 10% de dead tuples
autovacuum_analyze_scale_factor = 0.05  # Analyze com 5% de mudanças

# -----------------------------
# Locale & Encoding
# -----------------------------
datestyle = 'iso, mdy'
timezone = 'UTC'
lc_messages = 'en_US.utf8'
lc_monetary = 'en_US.utf8'
lc_numeric = 'en_US.utf8'
lc_time = 'en_US.utf8'
default_text_search_config = 'pg_catalog.english'

# -----------------------------
# Connection Settings
# -----------------------------
tcp_keepalives_idle = 60                # Segundos antes do primeiro keepalive
tcp_keepalives_interval = 10            # Intervalo entre keepalives
tcp_keepalives_count = 6                # Tentativas antes de desistir

# -----------------------------
# Performance Monitoring
# -----------------------------
shared_preload_libraries = 'pg_stat_statements'
pg_stat_statements.track = all
